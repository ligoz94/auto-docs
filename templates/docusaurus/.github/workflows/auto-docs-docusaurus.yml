name: ðŸ“š Auto Documentation (Docusaurus)

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]
    paths:
      - "**.ts"
      - "**.tsx"
      - "**.js"
      - "**.jsx"
      - "**.py"
      - "!docs/**"
      - "!.github/**"
      - "!node_modules/**"

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  update-documentation:
    name: ðŸ¤– Update Documentation
    runs-on: ubuntu-latest

    if: "!contains(github.event.pull_request.title, '[Auto]')"

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ”„ Fetch Base Branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}

      - name: ðŸ¤– Generate Documentation
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GITHUB_PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          npx auto-docs generate --base-branch origin/${{ github.event.pull_request.base.ref }}

      - name: ðŸ“Š Check Documentation Changes
        id: check_changes
        run: |
          if [[ -n $(git status -s docs/) ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ’¾ Commit Documentation Changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add docs/
          git commit -m "docs: auto-update from PR #${{ github.event.pull_request.number }}

          ðŸ¤– Generated with Auto-Docs (Docusaurus)
          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

      - name: ðŸ“¤ Push Changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: git push origin HEAD:${{ github.event.pull_request.head.ref }}

      - name: ðŸ’¬ Comment on PR
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“š Documentation Updated!

              The documentation has been automatically updated based on your code changes.

              ðŸ”— [View Documentation](https://your-docs-url.com)

              ---
              ðŸ¤– Generated by Auto-Docs`
            });
